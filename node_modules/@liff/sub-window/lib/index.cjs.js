"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib"),t=require("@liff/use"),r=require("@liff/is-in-client"),n=require("@liff/is-api-available"),i=require("@liff/consts"),o=require("@liff/logger"),s=require("@liff/util"),a=require("@liff/get-os"),u=require("@liff/server-api"),c=require("@liff/store"),f=require("@liff/message-bus"),l=require("@liff/is-sub-window"),d=require("@liff/close-window");function _(e){var t=u.getEndPoint("subWindowGetOrigin");return u.fetch(t(e))}var S={};function v(e,t){e&&S[e]&&S[e].forEach((function(e){e(t)}))}function g(e,t){S[e]||(S[e]=[]),S[e].push(t)}function h(e,t){if(S[e]){var r=S[e].indexOf(t);r>=0&&S[e].splice(r,1)}}var I,p,m,w,N,E=function(){function e(e){this.storage=e}return e.prototype.getItem=function(e){return this.storage.getItem("".concat(this.getKeyPrefix(),":").concat(e))},e.prototype.setItem=function(e,t){this.storage.setItem("".concat(this.getKeyPrefix(),":").concat(e),t)},e.prototype.removeItem=function(e){this.storage.removeItem("".concat(this.getKeyPrefix(),":").concat(e))},e.prototype.clear=function(){this.storage.clear()},e.prototype.getKeyPrefix=function(){return"".concat(i.STORE_KEY,":").concat(this.getLiffId())},e.prototype.getLiffId=function(){var e=c.getConfig().liffId;if(!e)throw s.createLiffError(i.INVALID_CONFIG,"liffId is necessary for liff.init()");return e},e}(),T=new E(new s.InMemoryStorage);function O(){var e=T.getItem("subWindowStatusUpdated");return null!==e&&JSON.parse(e)}function W(e){T.setItem("subWindowStatusUpdated",String(e))}function U(e){I=e}function b(){return I}function L(){return m}function A(){return w}function D(t){return void 0===t&&(t=f.WINDOW.MAIN),e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return[4,(N=new f.MessageBus(t)).setup()];case 1:return e.sent(),[2,N]}}))}))}function y(){return N}var C=new s.InMemoryStorage,B=new E(s.isNonBrowserEnvironment()?C:window.sessionStorage);function M(){return B.getItem("mainWindowOrigin")}function P(t,r){return void 0===r&&(r={}),e.__awaiter(this,void 0,void 0,(function(){var n,a,u,f,l,d,S,v;return e.__generator(this,(function(e){switch(e.label){case 0:if(null==(n=y())?void 0:n.isReady())return[3,5];if(a=JSON.stringify(r),u=c.getConfig().liffId,f=M(),!window.opener||!f||!u)throw s.createLiffError(i.EXCEPTION_IN_SUBWINDOW);l=!1,e.label=1;case 1:return e.trys.push([1,3,,4]),[4,_(u)];case 2:return d=e.sent(),l=d.subwindowCommonModule,[3,4];case 3:throw S=e.sent(),o.logger.debug(S),s.createLiffError(i.EXCEPTION_IN_SUBWINDOW);case 4:return v=l?f:location.origin,[2,new Promise((function(e){window.addEventListener("message",(function r(n){(function(e){if(e.data&&"string"==typeof e.data.type&&[i.SUB_WINDOW_STATUS.SUBMIT,i.SUB_WINDOW_STATUS.CANCEL].includes(e.data.type))return!0;return!1})(n)&&(window.removeEventListener("message",r),e({status:t,result:a}))})),window.opener.postMessage({status:t,result:a},v)}))];case 5:return n.send({eventName:t,data:r}),[4,new Promise((function(e){setTimeout(e,500)}))];case 6:return e.sent(),[2,{status:t,result:JSON.stringify(r)}]}}))}))}function R(e){var t,r=A();if(e.origin===r){var n=e.data;if(n){var s,a=n.status,u=n.result;try{s=JSON.parse(u||"{}")}catch(c){s={}}switch(a){case i.SUB_WINDOW_HEALTH_CHECK_MESSAGE:window.clearInterval(L()),j();break;case i.SUB_WINDOW_STATUS.CANCEL:case i.SUB_WINDOW_STATUS.SUBMIT:W(!0),window.clearInterval(L()),window.removeEventListener("message",R),v(a,s),null===(t=b())||void 0===t||t.postMessage({type:a},A());break;default:o.logger.debug("unexpected message")}}}}var x=function(t){return e.__awaiter(void 0,void 0,void 0,(function(){var r,n,o,s;return e.__generator(this,(function(e){if(O())return[2];switch(r=t.context,n=r.eventName,o=r.data,s=y(),n){case i.SUB_WINDOW_STATUS.INIT:K(!o.hasOpener);break;case i.SUB_WINDOW_STATUS.CANCEL:case i.SUB_WINDOW_STATUS.SUBMIT:W(!0),v(n,o),null==s||s.reply(t,{eventName:n});break;case i.SUB_WINDOW_STATUS.CLOSE:!1===O()&&(W(!0),v(i.SUB_WINDOW_STATUS.CLOSE,{})),j()}return[2]}))}))};function H(){window.clearInterval(p),window.clearInterval(L()),window.removeEventListener("message",R)}function K(e){if(void 0===e&&(e=!1),H(),W(!1),e){var t=b();t&&(t.close(),U(null))}}function j(){return e.__awaiter(this,void 0,void 0,(function(){var t;return e.__generator(this,(function(e){switch(e.label){case 0:return(t=y())?[4,t.teardown()]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}}))}))}function q(t){var r;return e.__awaiter(this,void 0,void 0,(function(){var n,o,u,c,l,d,S,g,h,I,N;return e.__generator(this,(function(E){switch(E.label){case 0:return(n=s.extractLiffId(t.url))?(K(!0),[4,j()]):[2,Promise.reject(s.createLiffError(i.INVALID_ARGUMENT,"params.url must be liff url or mini url"))];case 1:return E.sent(),U("ios"!==a.getOS()||s.isIpad()?window.open("","liffsubwindow","width=480, height=640, menubar=no, toolbar=no, scrollbars=yes"):window.open()),o=t.url,u=t.appData,(c=new URL(o)).searchParams.append(i.SUB_WINDOW_IDNTIFICATION_KEY,"true"),[4,D()];case 2:return l=E.sent(),c.searchParams.append(f.IDENTIFIER_KEY,l.identification.identifier),c.searchParams.append(f.CRYPTO_KEY,l.identification.cryptoKey),c.hostname=function(t){var r=e.__read(t.split(".")),n=r[0],i=r.slice(1);return e.__spreadArray(["".concat(n,"-ext")],e.__read(i),!1).join(".")}(c.hostname),d=c.toString(),[4,_(n)];case 3:if(S=E.sent(),g=S.origin,h=S.subwindowCommonModule,!(I=b()))throw s.createLiffError(i.CREATE_SUBWINDOW_FAILED);if(!h)return I.close(),[2];!function(e){w=e}(g),l.listen(x),l.setData("appData",u),window.addEventListener("message",R),E.label=4;case 4:return E.trys.push([4,6,,7]),[4,null===(r=t.onBeforeTransition)||void 0===r?void 0:r.call(t)];case 5:return E.sent(),[3,7];case 6:throw N=E.sent(),I.close(),N;case 7:return I.location.href=d,T=function(e,t){var r=b(),n={type:i.SUB_WINDOW_HEALTH_CHECK_MESSAGE};return t&&(n.message=JSON.stringify(t)),window.setInterval((function(){null==r||r.postMessage(n,e)}),i.SUB_WINDOW_HEALTH_CHECK_INTERVAL)}(g,u),m=T,function(e){p=e}(window.setInterval((function(){var e=b();e&&e.closed&&(H(),U(null),!1===O()&&(W(!0),v(i.SUB_WINDOW_STATUS.CLOSE,{})))}),i.SUB_WINDOW_MONITOR_CLOSE_INTERVAL)),[2]}var T}))}))}var G=null;function V(t){return e.__awaiter(this,void 0,void 0,(function(){var r,n,o,a,c,f,l,d,_,S,v,g,h,I,p=this;return e.__generator(this,(function(m){switch(m.label){case 0:if(r=t.msit,n=t.mstChallenge,o=t.reconnectCount,a=void 0===o?0:o,c=function(){return e.__awaiter(p,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return[4,(i=1e3,new Promise((function(e){return setTimeout(e,i)})))];case 1:return e.sent(),[4,V({msit:r,mstChallenge:n,onSuccess:t.onSuccess,onError:t.onError,reconnectCount:a+1})];case 2:return e.sent(),[2]}var i}))}))},f=function(){for(var r=[],n=0;n<arguments.length;n++)r[n]=arguments[n];G=null,t.onSuccess.apply(t,e.__spreadArray([],e.__read(r),!1))},l=function(){for(var r=[],n=0;n<arguments.length;n++)r[n]=arguments[n];G=null,t.onError.apply(t,e.__spreadArray([],e.__read(r),!1))},d=Date.now(),null===G&&(G=d),_=d-G,a>=10||_>6e5)return l(s.createLiffError(i.UNKNOWN,"Failed to connect")),[2];m.label=1;case 1:return m.trys.push([1,3,,5]),[4,u.requestWithoutErrorHandling(u.getEndPoint("subWindowSubscribe"),{method:"POST",body:JSON.stringify({msit:r,mstChallenge:n})})];case 2:return S=m.sent(),[3,5];case 3:return m.sent(),[4,c()];case 4:return m.sent(),[2];case 5:return S.status>=500?[4,c()]:[3,7];case 6:return m.sent(),[3,17];case 7:return S.status>=400&&500>S.status?[4,J(S)]:[3,9];case 8:return g=m.sent(),v=g?s.createLiffError(i.INVALID_ARGUMENT,g.errorDetail):s.createLiffError(i.UNKNOWN,"Some error happened in the server"),l(v),[3,17];case 9:return 200!==S.status?[3,16]:[4,J(S)];case 10:if(!(g=m.sent()))return l(s.createLiffError(i.UNKNOWN,"Some error happened in the server")),[2];switch(h=g.status,I=g.result,h){case i.SUB_WINDOW_STATUS.ERROR:return[3,11];case i.SUB_WINDOW_STATUS.CLOSE:case i.SUB_WINDOW_STATUS.CANCEL:case i.SUB_WINDOW_STATUS.SUBMIT:return[3,13]}return[3,14];case 11:return[4,c()];case 12:return m.sent(),[3,15];case 13:return f(h,I),[3,15];case 14:l(s.createLiffError(i.UNKNOWN,"Some error happened in the server")),m.label=15;case 15:return[3,17];case 16:l(s.createLiffError(i.UNKNOWN,"Some error happened in the server")),m.label=17;case 17:return[2]}}))}))}function J(t){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,t.json()];case 1:return[2,e.sent()];case 2:return e.sent(),[2,null];case 3:return[2]}}))}))}function k(e){var t={};return Object.keys(e).forEach((function(r){"closeButtonColor"===r?"white"===e[r]?t[r]="#ffffff":t[r]="#000000":t[r]=e[r]})),t}var Z={height:"full",closeButtonPosition:"right",closeButtonColor:"black",closeButtonLabel:""};function F(t){var r=t.appData,n=t.native,o=c.getConfig().liffId,a=c.getMSTChallenge(),f=s.extractLiffId(t.url);if(!o)return Promise.reject(s.createLiffError(i.UNAUTHORIZED,"liffId is invalid"));if(!a)return Promise.reject(s.createLiffError(i.UNAUTHORIZED,"mst_challenge is invalid"));if(!f)return Promise.reject(s.createLiffError(i.INVALID_ARGUMENT,"params.url must be liff url or mini url"));var l=Object.assign({},Z,n);return function(e){var t=e.mainLiffId,r=e.subLiffId,n=e.mstChallenge,o=e.appData,a=e.view;return t&&n?u.fetch(u.getEndPoint("subWindowGetMSIT"),{method:"POST",body:JSON.stringify({mainLiffId:t,subLiffId:r,mstChallenge:n,appData:o,view:a})}):Promise.reject(s.createLiffError(i.INVALID_ARGUMENT,"no proper argument"))}({mainLiffId:o,subLiffId:f,mstChallenge:a,appData:r,view:k(l)}).then((function(e){var t=e.msit;return V({msit:t,mstChallenge:a,onSuccess:function(e,t){v(e,t)},onError:function(e){v(i.SUB_WINDOW_STATUS.ERROR,e)}}),t})).then((function(r){return function(t,r){var n;return e.__awaiter(this,void 0,void 0,(function(){var o,s;return e.__generator(this,(function(e){switch(e.label){case 0:return o=t.url,(s=new URLSearchParams).set("msit",r),[4,null===(n=t.onBeforeTransition)||void 0===n?void 0:n.call(t)];case 1:return e.sent(),location.href="".concat(i.SUB_WINDOW_MODAL_SCHEME_URL,"?url=").concat(encodeURIComponent(o),"&").concat(s.toString()),[2]}}))}))}(t,r)}))}function Y(e){return n.validators.subwindowOpen(),r.isInClient()?F(e):q(e)}function X(e){if(!e.mst||!e.status)return Promise.reject(s.createLiffError(i.INVALID_ARGUMENT,"no proper argument"));var t=JSON.stringify(e);return u.fetch(u.getEndPoint("subWindowPost"),{method:"POST",body:t})}function z(){if(!l.isSubWindow())throw s.createLiffError(i.UNAUTHORIZED,"this api can be only called in child window")}function Q(t){return void 0===t&&(t={}),z(),r.isInClient()?function(t){return void 0===t&&(t={}),e.__awaiter(this,void 0,void 0,(function(){var r,n;return e.__generator(this,(function(e){switch(e.label){case 0:return(r=c.getMST())?[4,X({mst:r,status:i.SUB_WINDOW_STATUS.CANCEL,result:t})]:[2,Promise.reject(s.createLiffError(i.UNAUTHORIZED,"mst is invalid"))];case 1:return n=e.sent(),W(!0),[2,n]}}))}))}(t):function(e){return void 0===e&&(e={}),P(i.SUB_WINDOW_STATUS.CANCEL,e)}(t)}function $(t){return void 0===t&&(t={}),z(),r.isInClient()?function(t){return void 0===t&&(t={}),e.__awaiter(this,void 0,void 0,(function(){var r,n;return e.__generator(this,(function(e){switch(e.label){case 0:return(r=c.getMST())?[4,X({mst:r,status:i.SUB_WINDOW_STATUS.SUBMIT,result:t})]:[2,Promise.reject(s.createLiffError(i.UNAUTHORIZED,"mst is invalid"))];case 1:return n=e.sent(),W(!0),[2,n]}}))}))}(t):function(e){return void 0===e&&(e={}),P(i.SUB_WINDOW_STATUS.SUBMIT,e)}(t)}function ee(){return z(),r.isInClient()?function(){return e.__awaiter(this,void 0,void 0,(function(){var t;return e.__generator(this,(function(e){switch(e.label){case 0:return!1!==O()?[3,2]:(t=c.getMST())?[4,X({mst:t,status:i.SUB_WINDOW_STATUS.CLOSE,result:{}})]:[2,Promise.reject(s.createLiffError(i.UNAUTHORIZED,"mst is invalid"))];case 1:e.sent(),e.label=2;case 2:return d.closeWindow(),[2]}}))}))}():function(){return e.__awaiter(this,void 0,void 0,(function(){var t;return e.__generator(this,(function(e){return(null==(t=y())?void 0:t.isReady())?(t.send({eventName:i.SUB_WINDOW_STATUS.CLOSE}),[2,new Promise((function(e){setTimeout((function(){d.closeWindow(),e()}),i.SUB_WINDOW_HEALTH_CHECK_INTERVAL)}))]):(d.closeWindow(),[2,Promise.resolve()])}))}))}()}function te(){return z(),function(){var e,t=c.getAppData();try{e=t?JSON.parse(t):{}}catch(r){e={}}return Promise.resolve(e)}()}var re={on:g,off:h,open:Y,cancel:Q,submit:$,close:ee,getAppData:te},ne=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return e.__extends(r,t),Object.defineProperty(r.prototype,"name",{get:function(){return"subWindow"},enumerable:!1,configurable:!0}),r.prototype.install=function(){var t=this;return{on:g.bind(this),off:h.bind(this),open:function(r){return Y.call(t,e.__assign(e.__assign({},r),{onBeforeTransition:void 0}))},cancel:Q.bind(this),submit:$.bind(this),close:ee.bind(this),getAppData:te.bind(this)}},r}(t.LiffModule);exports.SubWindowModule=ne,exports.getAppData=function(e){var t=e.mst;return t?u.fetch(u.getEndPoint("subWindowGetAppData"),{method:"POST",body:JSON.stringify({mst:t})}):Promise.reject(s.createLiffError(i.INVALID_ARGUMENT,"no proper argument"))},exports.getMSTByMSIT=function(e){var t=e.msit,r=e.mstVerifier;return t&&r?u.fetch(u.getEndPoint("subWindowGetMSTByMSIT"),{method:"POST",body:JSON.stringify({msit:t,mstVerifier:r})}):Promise.reject(s.createLiffError(i.INVALID_ARGUMENT,"no proper argument"))},exports.getMainWindowOrigin=M,exports.getMessageBus=y,exports.initMessageBus=D,exports.setMainWindowOrigin=function(e){B.setItem("mainWindowOrigin",e)},exports.subWindow=re;
