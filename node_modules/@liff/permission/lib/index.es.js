import{__awaiter as e,__generator as t,__values as n,__spreadArray as r,__read as i,__extends as o}from"tslib";import{PERMISSION_NAMES as s,INVALID_ARGUMENT as c,UNAUTHORIZED as a,FORBIDDEN as u,UNKNOWN as l}from"@liff/consts";import{createLiffError as f,extractChannelIdFromLiffId as h}from"@liff/util";import{getContext as p,getAccessToken as d,getConfig as v,setAccessToken as m}from"@liff/store";import{verifyAccessToken as w,fetch as b,getEndPoint as y}from"@liff/server-api";import{isInClient as g}from"@liff/is-in-client";import{subWindow as C}from"@liff/sub-window";import{isApiAvailable as k}from"@liff/is-api-available";import{LiffModule as j}from"@liff/use";function I(r){return e(this,void 0,void 0,(function(){var e,i,o,u,l,h,v;return t(this,(function(t){switch(t.label){case 0:return function(e){if(!s.includes(e))throw f(c,"Unexpected permission name.");var t=p();return!!(null==t?void 0:t.scope.includes(e))}(r)?(e=d())?[4,w(e)]:[3,2]:[2,{state:"unavailable"}];case 1:i=t.sent(),o=unescape(i.scope).split(" ");try{for(u=n(o),l=u.next();!l.done;l=u.next())if(l.value.includes(r))return[2,{state:"granted"}]}catch(m){h={error:m}}finally{try{l&&!l.done&&(v=u.return)&&v.call(u)}finally{if(h)throw h.error}}return[2,{state:"prompt"}];case 2:throw f(a,"Need access_token for api call, Please login first")}}))}))}function A(){var e,t,n=p();return!!n&&("square_chat"!==n.type&&(k("skipChannelVerificationScreen")||!g()&&(null===(t=null===(e=n.availability)||void 0===e?void 0:e.skipChannelVerificationScreen)||void 0===t?void 0:t.permission)))}function P(){var e=v().liffId;if(e)return b("".concat(y("unauthorizedPermissions"),"?liffId=").concat(e),{headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer ".concat(d())}});throw f(a,"liffId is required")}var S,T=C.on,_=C.off,q=C.open,x=function(){function n(n,r){var i=this;this.onSubmit=function(n){var r=n.newAccessToken,o=n.ICA_ERROR;return e(i,void 0,void 0,(function(){return t(this,(function(e){return r?this.resolve({newAccessToken:r}):o&&this.reject(f(l,o)),this.teardown(),[2]}))}))},this.onClose=function(){return e(i,void 0,void 0,(function(){return t(this,(function(e){return this.reject(f(a,"user didn't allow the agreement")),this.teardown(),[2]}))}))},this.onCancel=function(){return e(i,void 0,void 0,(function(){return t(this,(function(e){return this.reject(f(a,"user didn't allow the agreement")),this.teardown(),[2]}))}))},this.onError=function(n){return e(i,void 0,void 0,(function(){return t(this,(function(e){return this.reject(n),this.teardown(),[2]}))}))},this.resolve=n,this.reject=r,this.setup()}return n.prototype.setup=function(){T("submit",this.onSubmit),T("close",this.onClose),T("cancel",this.onCancel),T("error",this.onError)},n.prototype.teardown=function(){_("submit",this.onSubmit),_("close",this.onClose),_("cancel",this.onCancel),_("error",this.onError),S=void 0},n.prototype.open=function(e){var t=v().liffId;t?q({url:"".concat("https://liff.line.me/1656032314-Xgrw5Pmk"),appData:{liffId:t,channelId:h(t),accessToken:d()},onBeforeTransition:e}).catch(this.reject):this.reject(f(a,"liffId is required"))},n}();function E(){return e(this,void 0,void 0,(function(){var n,r,i=this;return t(this,(function(o){switch(o.label){case 0:if(!A())throw f(u,"SkipChannelVerificationScreen is unavailable.");return S&&S.teardown(),n=function(){return e(i,void 0,void 0,(function(){var e;return t(this,(function(t){switch(t.label){case 0:return[4,P()];case 1:if(e=t.sent(),(g()?e:e.filter((function(e){return"chat_message.write"!==e}))).length<=0)throw f(u,"All permissions have already been approved.");return[2]}}))}))},[4,new Promise((function(e,t){(S=new x(e,t)).open(n)}))];case 1:return r=o.sent().newAccessToken,m(r),[2]}}))}))}function R(){return e(this,void 0,void 0,(function(){var e,n;return t(this,(function(t){switch(t.label){case 0:if(!(e=d()))throw f(a,"Need access_token for api call, Please login first");return[4,w(e)];case 1:return n=t.sent(),[2,decodeURIComponent(n.scope).split(" ").filter((function(e){return""!==e}))]}}))}))}function V(n,o){var s=this;return function(){for(var c=[],a=0;a<arguments.length;a++)c[a]=arguments[a];return e(s,void 0,void 0,(function(){var e,s,a;return t(this,(function(t){switch(t.label){case 0:return e=(c.length>0?c[c.length-1]:{}).ignorePermissionCheck,s=void 0!==e&&e,[4,I(o)];case 1:if("unavailable"!==(a=t.sent().state))return[3,2];throw f(u,"The permission is not in LIFF app scope.");case 2:return"prompt"!==a||!A()||s||!g()&&"chat_message.write"===o?[3,4]:[4,E()];case 3:return t.sent(),[3,5];case 4:s&&c.pop(),t.label=5;case 5:return[4,n.apply(void 0,r([],i(c),!1))];case 6:return[2,t.sent()]}}))}))}}var z=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return o(t,e),Object.defineProperty(t.prototype,"name",{get:function(){return"permission"},enumerable:!1,configurable:!0}),t.prototype.install=function(){return{query:I,requestAll:E,getGrantedAll:R}},t}(j),B=new z;export{z as PermissionModule,V as attachChecker,B as module};
