"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib"),r=require("@liff/use"),t=require("@liff/consts"),n=require("@liff/get-os"),i=require("@liff/store"),o=require("@liff/util"),u=require("@liff/is-api-available"),a=require("@liff/is-in-client"),c=require("@liff/open-window"),s=require("@liff/server-api"),l=require("@liff/permanent-link");function f(r,t){return e.__awaiter(this,void 0,void 0,(function(){var n,i;return e.__generator(this,(function(e){switch(e.label){case 0:return n=s.getEndPoint("createShortcutOnHomeScreen"),(i=new URL(n)).searchParams.append("liffId",r),i.searchParams.append("url",t.url),t.description&&i.searchParams.append("description",t.description),[4,s.fetch(i.toString())];case 1:return[2,e.sent().shortcutPageUrl]}}))}))}function d(e){if(o.isLineCustomUrlScheme(e))throw o.createLiffError(t.INVALID_ARGUMENT,"LINE URL scheme are not supported in the current environment.")}function h(r,t){return e.__awaiter(this,void 0,void 0,(function(){var n;return e.__generator(this,(function(e){switch(e.label){case 0:return a.isInClient()?[2]:[4,new Promise((function(e){setTimeout(e,1e3)}))];case 1:return e.sent(),"hidden"===document.visibilityState?[2]:(d(t.url),[4,f(r,t)]);case 2:return n=e.sent(),c.openWindow({url:n,external:!0}),[2]}}))}))}function p(r,t){return e.__awaiter(this,void 0,void 0,(function(){var n,i;return e.__generator(this,(function(e){switch(e.label){case 0:return n={liffId:r,targetUrl:t.url,description:t.description},i="".concat("line://shortcut/liff","?").concat(o.qs.stringify(n)),location.href=i,[4,h(r,t)];case 1:return e.sent(),[2]}}))}))}function v(r,t){return e.__awaiter(this,void 0,void 0,(function(){var n;return e.__generator(this,(function(e){switch(e.label){case 0:return d(t.url),[4,f(r,t)];case 1:return n=e.sent(),c.openWindow({url:n,external:!0}),[2]}}))}))}function m(e){var r;if(void 0===e.url||null===e.url||""===e.url)throw o.createLiffError(t.INVALID_ARGUMENT,"no proper argument");var n=i.getContext();if(!(null===(r=null==n?void 0:n.availability.addToHomeLineScheme)||void 0===r?void 0:r.permission)){if(o.isLineCustomUrlScheme(e.url))throw o.createLiffError(t.FORBIDDEN,"No permission to specify line schema in url.");if(e.description)throw o.createLiffError(t.FORBIDDEN,"No permission to specify description.")}if(!o.isLineCustomUrlScheme(e.url)){if(!n)throw o.createLiffError(t.FORBIDDEN,"Could not get Context from server.");n.liffId!==o.extractLiffId(e.url)&&l.validatePermalinkGeneratability(e.url,n.endpointUrl)}}function _(r){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return m(r),u.validators.internalCreateShortcutOnHomeScreen(),[4,S(r)];case 1:return e.sent(),[2]}}))}))}function w(r){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return m(r),u.validators.createShortcutOnHomeScreen(),[4,S(r)];case 1:return e.sent(),[2]}}))}))}function S(r){return e.__awaiter(this,void 0,void 0,(function(){var u;return e.__generator(this,(function(e){switch(e.label){case 0:if(!(u=i.getConfig().liffId))throw o.createLiffError(t.INIT_FAILED,"Invalid LIFF ID.");return"ios"===n.getOS()?[4,v(u,r)]:[3,2];case 1:return e.sent(),[3,4];case 2:return[4,p(u,r)];case 3:e.sent(),e.label=4;case 4:return[2]}}))}))}var g=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return e.__extends(t,r),Object.defineProperty(t.prototype,"name",{get:function(){return"createShortcutOnHomeScreen"},enumerable:!1,configurable:!0}),t.prototype.install=function(){return function(e){return w(e)}},t}(r.LiffModule),I=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return e.__extends(t,r),Object.defineProperty(t.prototype,"name",{get:function(){return"internalCreateShortcutOnHomeScreen"},enumerable:!1,configurable:!0}),t.prototype.install=function(){return function(e){return _(e)}},t}(r.LiffModule);exports.CreateShortcutOnHomeScreenModule=g,exports.InternalCreateShortcutOnHomeScreenModule=I,exports.createShortcutOnHomeScreen=w,exports.internalCreateShortcutOnHomeScreen=_;
