"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var r=require("tslib"),e=require("@liff/consts"),n=require("@liff/util"),t=require("@liff/store"),a=require("@liff/use"),i=/([\x90\x9D\x81\x8D\x8F<"{|}>\\^`“›„•‚ŽŠ…’—ž–‘”‡™‰ŒšŸ‹œ†¥¿©áÄýÍÎðô]|\n|.*#.*#|%(?![0-9A-Fa-f]{2})[^%]{0,2})/,o=function(r){if(i.test(r))throw n.createLiffError(e.INVALID_ARGUMENT,"invalid URL.");var t=new URL(r),a=t.username,o=t.password,u=t.hash,f=t.search;return{username:a,password:o,pathname:t.pathname,hash:u,origin:t.origin,search:f}},u=function(r){return r.substring(1).split("&").filter((function(r){return!/^liff\./.test(r)&&Boolean(r)}))},f=function(r,e){var n=r.substring(e.length);return"/"===n?"":(n.length>0&&"/"!==n[0]&&(n="/"+n),n)},c=function(r){return encodeURIComponent(r).replace(/[!'()*]/g,(function(r){return"%"+r.charCodeAt(0).toString(16).toUpperCase()}))},s=function(e,n){var t=function(e,n){for(var t=r.__spreadArray([],r.__read(e),!1),a=0;a<n.length;a++){var i=n[a],o=t.indexOf(i);o>-1&&t.splice(o,1)}return t}(function(e){var n,t,a=e.replace(/\+/g,"%2B"),i=new URLSearchParams(a),o=[];try{for(var u=r.__values(i.entries()),f=u.next();!f.done;f=u.next()){var s=r.__read(f.value,2),l=s[0],h=s[1];o.push("".concat(c(l),"=").concat(c(h)))}}catch(d){n={error:d}}finally{try{f&&!f.done&&(t=u.return)&&t.call(u)}finally{if(n)throw n.error}}if(0===o.length)return[""];var p=e.split("&");return o.map((function(r,e){return r.endsWith("=")&&!p[e].endsWith("=")?r.slice(0,-1):r}))}(u(e).join("&")),u(n)).join("&");return""!==t?"?".concat(t):""},l=function(r){var n=new RegExp("^".concat(e.CREDENTIAL_KEYS.join("|"))),t=r.substring(1).split("&").filter((function(r){return!n.test(r)&&Boolean(r)})).join("&");return t?"#".concat(t):""},h=function(r,e){return 0===e.indexOf(r)&&(r.endsWith("/")&&(r=r.substring(0,r.length-1)),void 0===e[r.length]||"/"===e[r.length])},p=function(r,t){var a=o(r),i=new URL(t);if(a.username!==i.username||a.password!==i.password)throw n.createLiffError(e.INVALID_ARGUMENT,"invalid URL.");if(i.origin!==a.origin||!h(i.pathname,a.pathname))throw n.createLiffError(e.INVALID_ARGUMENT,"invalid URL.")},d=function(a){function i(){var i=null!==a&&a.apply(this,arguments)||this;return i.extraParams="",i.getAndValidateContext=function(){var r=t.getContext();if(!r)throw n.createLiffError(e.INIT_FAILED,"Could not get Context from server.");if(!r.endpointUrl)throw n.createLiffError(e.INIT_FAILED,"Could not get endpointUrl from server.");if(!r.permanentLinkPattern)throw n.createLiffError(e.INIT_FAILED,"Could not get permanentLinkPattern from server.");return r},i.createUrl=function(){var r=i.getAndValidateContext(),a=window.location,o=a.pathname,u=a.search,f=a.hash,c=a.origin,s=new URL(r.endpointUrl);if(s.origin!==c||!h(s.pathname,o))throw n.createLiffError(e.INVALID_CONFIG,"Current page is not under entrypoint.");var l=o.substring(s.pathname.length);l.length>0&&"/"!==l[0]&&(l="/"+l);var p=new RegExp("^".concat(e.CREDENTIAL_KEYS.join("|"))),d=f.substring(1).split("&").filter((function(r){return!p.test(r)&&Boolean(r)})).join("&"),g=d===s.hash.substring(1)?"":d,m=function(r){return r.substring(1).split("&").filter((function(r){return!/liff\.state/.test(r)&&Boolean(r)}))},I=m(u),v=m(s.search);i.extraParams&&I.push(i.extraParams);for(var L=0;L<v.length;L++){var _=v[L],E=I.indexOf(_);E>-1&&I.splice(E,1)}var x=I.join("&"),N="".concat(l).concat(""!==x?"?".concat(x):"").concat(g?"#".concat(g):"");return"".concat(e.PERMANENT_LINK_ORIGIN).concat(t.getConfig().liffId).concat(N)},i.createUrlBy=function(a){return r.__awaiter(i,void 0,void 0,(function(){var i,u,c,h,d,g;return r.__generator(this,(function(r){if(!(i=t.getConfig().liffId))throw n.createLiffError(e.INIT_FAILED,"Should run after liff init.");return u=this.getAndValidateContext(),p(a,u.endpointUrl),c=o(a),h=new URL(u.endpointUrl),d=u.miniDomainAllowed?e.PERMANENT_LINK_ORIGIN_MINI:e.PERMANENT_LINK_ORIGIN,g=u.miniDomainAllowed&&u.miniAppId?u.miniAppId:i,[2,d.concat(g,f(c.pathname,h.pathname),s(c.search,h.search),l(c.hash))]}))}))},i.setExtraQueryParam=function(r){i.extraParams=r},i.install=function(){return{createUrl:i.createUrl,createUrlBy:i.createUrlBy,setExtraQueryParam:i.setExtraQueryParam}},i}return r.__extends(i,a),Object.defineProperty(i.prototype,"name",{get:function(){return"permanentLink"},enumerable:!1,configurable:!0}),i}(a.LiffModule),g=new d;exports.PermanentLinkModule=d,exports.module=g,exports.validatePermalinkGeneratability=p;
