import{__spreadArray as n,__read as t,__values as r,__extends as e,__awaiter as i,__generator as a}from"tslib";import{INVALID_ARGUMENT as o,CREDENTIAL_KEYS as c,INIT_FAILED as u,INVALID_CONFIG as s,PERMANENT_LINK_ORIGIN as f,PERMANENT_LINK_ORIGIN_MINI as l}from"@liff/consts";import{createLiffError as h}from"@liff/util";import{getContext as p,getConfig as m}from"@liff/store";import{LiffModule as d}from"@liff/use";var g=/([\x90\x9D\x81\x8D\x8F<"{|}>\\^`“›„•‚ŽŠ…’—ž–‘”‡™‰ŒšŸ‹œ†¥¿©áÄýÍÎðô]|\n|.*#.*#|%(?![0-9A-Fa-f]{2})[^%]{0,2})/,v=function(n){if(g.test(n))throw h(o,"invalid URL.");var t=new URL(n),r=t.username,e=t.password,i=t.hash,a=t.search;return{username:r,password:e,pathname:t.pathname,hash:i,origin:t.origin,search:a}},w=function(n){return n.substring(1).split("&").filter((function(n){return!/^liff\./.test(n)&&Boolean(n)}))},x=function(n,t){var r=n.substring(t.length);return"/"===r?"":(r.length>0&&"/"!==r[0]&&(r="/"+r),r)},U=function(n){return encodeURIComponent(n).replace(/[!'()*]/g,(function(n){return"%"+n.charCodeAt(0).toString(16).toUpperCase()}))},y=function(e,i){var a=function(r,e){for(var i=n([],t(r),!1),a=0;a<e.length;a++){var o=e[a],c=i.indexOf(o);c>-1&&i.splice(c,1)}return i}(function(n){var e,i,a=n.replace(/\+/g,"%2B"),o=new URLSearchParams(a),c=[];try{for(var u=r(o.entries()),s=u.next();!s.done;s=u.next()){var f=t(s.value,2),l=f[0],h=f[1];c.push("".concat(U(l),"=").concat(U(h)))}}catch(m){e={error:m}}finally{try{s&&!s.done&&(i=u.return)&&i.call(u)}finally{if(e)throw e.error}}if(0===c.length)return[""];var p=n.split("&");return c.map((function(n,t){return n.endsWith("=")&&!p[t].endsWith("=")?n.slice(0,-1):n}))}(w(e).join("&")),w(i)).join("&");return""!==a?"?".concat(a):""},b=function(n){var t=new RegExp("^".concat(c.join("|"))),r=n.substring(1).split("&").filter((function(n){return!t.test(n)&&Boolean(n)})).join("&");return r?"#".concat(r):""},C=function(n,t){return 0===t.indexOf(n)&&(n.endsWith("/")&&(n=n.substring(0,n.length-1)),void 0===t[n.length]||"/"===t[n.length])},L=function(n,t){var r=v(n),e=new URL(t);if(r.username!==e.username||r.password!==e.password)throw h(o,"invalid URL.");if(e.origin!==r.origin||!C(e.pathname,r.pathname))throw h(o,"invalid URL.")},P=function(n){function t(){var t=null!==n&&n.apply(this,arguments)||this;return t.extraParams="",t.getAndValidateContext=function(){var n=p();if(!n)throw h(u,"Could not get Context from server.");if(!n.endpointUrl)throw h(u,"Could not get endpointUrl from server.");if(!n.permanentLinkPattern)throw h(u,"Could not get permanentLinkPattern from server.");return n},t.createUrl=function(){var n=t.getAndValidateContext(),r=window.location,e=r.pathname,i=r.search,a=r.hash,o=r.origin,u=new URL(n.endpointUrl);if(u.origin!==o||!C(u.pathname,e))throw h(s,"Current page is not under entrypoint.");var l=e.substring(u.pathname.length);l.length>0&&"/"!==l[0]&&(l="/"+l);var p=new RegExp("^".concat(c.join("|"))),d=a.substring(1).split("&").filter((function(n){return!p.test(n)&&Boolean(n)})).join("&"),g=d===u.hash.substring(1)?"":d,v=function(n){return n.substring(1).split("&").filter((function(n){return!/liff\.state/.test(n)&&Boolean(n)}))},w=v(i),x=v(u.search);t.extraParams&&w.push(t.extraParams);for(var U=0;U<x.length;U++){var y=x[U],b=w.indexOf(y);b>-1&&w.splice(b,1)}var L=w.join("&"),P="".concat(l).concat(""!==L?"?".concat(L):"").concat(g?"#".concat(g):"");return"".concat(f).concat(m().liffId).concat(P)},t.createUrlBy=function(n){return i(t,void 0,void 0,(function(){var t,r,e,i,o,c;return a(this,(function(a){if(!(t=m().liffId))throw h(u,"Should run after liff init.");return r=this.getAndValidateContext(),L(n,r.endpointUrl),e=v(n),i=new URL(r.endpointUrl),o=r.miniDomainAllowed?l:f,c=r.miniDomainAllowed&&r.miniAppId?r.miniAppId:t,[2,o.concat(c,x(e.pathname,i.pathname),y(e.search,i.search),b(e.hash))]}))}))},t.setExtraQueryParam=function(n){t.extraParams=n},t.install=function(){return{createUrl:t.createUrl,createUrlBy:t.createUrlBy,setExtraQueryParam:t.setExtraQueryParam}},t}return e(t,n),Object.defineProperty(t.prototype,"name",{get:function(){return"permanentLink"},enumerable:!1,configurable:!0}),t}(d),R=new P;export{P as PermanentLinkModule,R as module,L as validatePermalinkGeneratability};
