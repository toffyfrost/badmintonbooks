"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib"),t=require("@liff/use"),r=require("@liff/ready"),n=require("@liff/is-logged-in"),o=require("@liff/util"),i=require("@liff/store"),a=require("@liff/check-availability"),s=require("@liff/consts"),c=require("@liff/extensions"),l=require("@liff/is-in-client"),f=require("@liff/logout"),u=require("@liff/is-sub-window"),d=require("@liff/sub-window"),g=require("@liff/server-api"),h=require("@liff/logger"),_=require("@liff/get-line-version"),v=require("@liff/native-bridge"),p=require("@liff/is-api-available"),w=require("@liff/get-os"),I=require("@liff/login"),b=require("@liff/close-window"),m=require("@liff/message-bus"),C=require("@liff/hooks"),T=require("@liff/i18n"),k={iconColor:"#111111",statusBarColor:"BLACK",titleTextColor:"#111111",titleSubtextColor:"#B7B7B7",titleButtonColor:"#111111",titleBackgroundColor:"#FFFFFF",progressBarColor:"#06C755",progressBackgroundColor:"#FFFFFF",titleButtonAreaBackgroundColor:"#1FFFFFFF",titleButtonAreaBorderColor:"#26000000",baseBackgroundColor:"#FFFFFF",baseTextColor:"#000000",lightButtonBorderColor:"rgba(0, 0, 0, 0.15)"},F={iconColor:"#FFFFFF",statusBarColor:"WHITE",titleTextColor:"#FFFFFF",titleSubtextColor:"#949494",titleButtonColor:"#FFFFFF",titleBackgroundColor:"#111111",progressBarColor:"#06C755",progressBackgroundColor:"#111111",titleButtonAreaBackgroundColor:"#1FFFFFFF",titleButtonAreaBorderColor:"#26000000",baseBackgroundColor:"#000000",baseTextColor:"#FFFFFF",lightButtonBorderColor:"rgba(255, 255, 255, 0.5)"};function E(){var e;D("color-scheme",((null==(e=i.getContext())?void 0:e.menuColorSetting)||{adaptableColorSchemes:["light"]}).adaptableColorSchemes.join(" "));var t=window.matchMedia("(prefers-color-scheme: dark)");L({matches:null==t?void 0:t.matches,media:null==t?void 0:t.media}),t.addEventListener?t.addEventListener("change",L):t.addListener&&t.addListener(L)}function L(t){var r=i.getContext(),n=(null==r?void 0:r.menuColorSetting)||{adaptableColorSchemes:["light"],lightModeColor:k,darkModeColor:F},o=n.adaptableColorSchemes,a=n.lightModeColor,s=n.darkModeColor,c=o.includes("dark");t.matches&&c?A(e.__assign(e.__assign({},F),s)):A(e.__assign(e.__assign({},k),a))}function A(e){var t=e.iconColor,r=e.statusBarColor,n=e.titleTextColor,i=e.titleSubtextColor,a=e.titleButtonColor,s=e.titleBackgroundColor,c=e.progressBarColor,l=e.progressBackgroundColor,f=e.titleButtonAreaBackgroundColor,u=e.titleButtonAreaBorderColor,d=e.baseBackgroundColor,g=e.baseTextColor,h=e.lightButtonBorderColor;D("--liff-base-background-color",d),D("--liff-base-text-color",g),D("--liff-base-background-rgb-color",o.convertHexToRgb(d)),D("--liff-base-text-rgb-color",o.convertHexToRgb(g)),D("--liff-light-button-border-color",h),D("--liff-title-text-color",n),D("--liff-title-background-color",s),D("--liff-title-button-color",a),D("--liff-icon-color",t),D("--liff-status-bar-color",r),D("--liff-title-subtext-color",i),D("--liff-progress-bar-color",c),D("--liff-progress-background-color",l),D("--liff-title-button-area-background-color",o.convertArgbToRgba(f)),D("--liff-title-button-area-border-color",o.convertArgbToRgba(u))}function D(e,t){document.documentElement.style.setProperty(e,t)}var S={addToHomeScreen:function(e){if(!new a.CheckAvailability(e).invoke("addToHomeScreen"))throw o.createLiffError(s.FORBIDDEN,"No permission for liff.addToHomeScreen()")},scanCode:function(e){if(!new a.CheckAvailability(e).invoke("scanCode"))return Promise.reject(o.createLiffError(s.FORBIDDEN,"No permission for liff.scanCode()"))},getAdvertisingId:function(e){if(!new a.CheckAvailability(e).invoke("getAdvertisingId"))return Promise.reject(o.createLiffError(s.FORBIDDEN,"No permission for liff.getAdvertisingId()"))},initPlugins:function(){}};function y(t){return e.__awaiter(this,void 0,void 0,(function(){var r;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,c.load()];case 1:return(r=e.sent())?(r.install(t,S),[2]):[2]}}))}))}function N(){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return[4,g.fetch(g.getEndPoint("certs"))];case 1:return[2,e.sent()]}}))}))}function B(t,r,n){return e.__awaiter(this,void 0,void 0,(function(){var o;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,crypto.subtle.importKey("jwk",t,{name:"ECDSA",namedCurve:"P-256"},!1,["verify"])];case 1:return o=e.sent(),[4,crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},o,n,r)];case 2:return[2,e.sent()]}}))}))}function x(t,r){return e.__awaiter(this,void 0,void 0,(function(){var n,i,a,c,l,f,u,d,g,h,_,v,p,w,I,b;return e.__generator(this,(function(m){switch(m.label){case 0:return n=t.split("."),i=e.__read(n,3),a=i[0],c=i[1],l=i[2],f=JSON.parse(o.base64Url.decode(a)),u=JSON.parse(o.base64Url.decodeUnicode(c)),d=o.convertArrayBuffer(o.base64Url.decode(l)),g=o.convertArrayBuffer("".concat(a,".").concat(c)),[4,N()];case 1:if(h=m.sent(),!(_=h.keys.find((function(e){return e.kid===f.kid}))))return[3,6];if(delete _.alg,"ES256"!==f.alg)throw o.createLiffError(s.INVALID_ID_TOKEN,'Invalid "alg" value in ID_TOKEN');v=void 0,m.label=2;case 2:return m.trys.push([2,4,,5]),[4,B(_,g,d)];case 3:return v=m.sent(),[3,5];case 4:throw p=m.sent(),o.createLiffError(s.INVALID_ID_TOKEN,"".concat("Failed to use Crypto API to verify ID_TOKEN",": ").concat(p));case 5:if(v){if(w=u.iss!=="https://access.".concat("line.me"),I=u.aud!==r,b=1e3*u.exp<Date.now(),w)throw o.createLiffError(s.INVALID_ID_TOKEN,'Invalid "iss" value in ID_TOKEN');if(I)throw o.createLiffError(s.INVALID_ID_TOKEN,'Invalid "aud" value in ID_TOKEN');if(b)throw o.createLiffError(s.INVALID_ID_TOKEN,'Invalid "exp" value in ID_TOKEN');return[2,u]}throw o.createLiffError(s.INVALID_ID_TOKEN,"Invalid signature in ID_TOKEN");case 6:throw o.createLiffError(s.INVALID_ID_TOKEN,'Invalid "kid" value in ID_TOKEN');case 7:return[2]}}))}))}function O(e){var t=e.split(".");if(t[1])try{var r=t[1].replace(/-/g,"+").replace(/_/g,"/");return JSON.parse(window.atob(r))}catch(n){return null}return null}function q(e){var t=e.pathname,r=e.query,n=r?"?".concat(o.qs.stringify(r)):"",i="".concat("liff://").concat(t).concat(n);location.href=i}var U=null;function W(){"boolean"==typeof U&&h.logger.warn("liff.init is not expected to be called more than once"),U=!!i.getIsSubsequentLiffApp()||!(!l.isInClient()||o.qs.parse(window.location.hash).feature_token||i.getFeatureToken())&&(i.setIsSubsequentLiffApp(!0),!0)}function M(){return Boolean(U)}function P(t,r){return e.__awaiter(this,void 0,void 0,(function(){var n;return e.__generator(this,(function(e){switch(e.label){case 0:return(n=i.getMST())?[2,n]:t&&r?[4,d.getMSTByMSIT({msit:t,mstVerifier:r})]:[3,2];case 1:return[2,e.sent().mst];case 2:return[2,null]}}))}))}function H(e){return g.fetch("".concat(g.getEndPoint("apps"),"/").concat(e,"/featureToken"))}function V(t){return e.__awaiter(this,void 0,void 0,(function(){var r,a,s,c;return e.__generator(this,(function(l){switch(l.label){case 0:return r=o.qs.parse(window.location.hash),a=function(t){for(var r,n,o=[],i=1;i<arguments.length;i++)o[i-1]=arguments[i];var a=function(e){Object.keys(e).filter((function(t){return null!==e[t]&&void 0!==e[t]})).forEach((function(r){t[r]=e[r]}))};try{for(var s=e.__values(o),c=s.next();!c.done;c=s.next()){a(c.value)}}catch(l){r={error:l}}finally{try{c&&!c.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}return t}({access_token:i.getAccessToken(),context_token:i.getRawContext(),feature_token:i.getFeatureToken(),id_token:i.getIDToken(),client_id:i.getClientId(),mst_challenge:i.getMSTChallenge(),mst_verifier:i.getMSTVerifier(),msit:i.getMSIT()},r),M()?n.isLoggedIn()?[4,H(t)]:[3,2]:[3,3];case 1:s=l.sent().featureToken,a.feature_token||(a.feature_token=s),l.label=2;case 2:(c=o.extractChannelIdFromLiffId(t))&&(a.client_id=c),l.label=3;case 3:return[2,a]}}))}))}function K(e){if(e.persisted&&p.isApiAvailable("multipleLiffTransition"))if("ios"===w.getOS())window.location.reload();else{var t=i.getConfig().liffId,r=i.getFeatureToken();if(!t)throw o.createLiffError(s.INIT_FAILED,"Invalid LIFF ID.");if(!r)throw o.createLiffError(s.FORBIDDEN,"Invalid featureToken for client features");q({pathname:"app/".concat(t),query:{feature_token:r}})}}function R(t){var r,a;return e.__awaiter(this,void 0,void 0,(function(){var c,l,f,w,b,m,C,T,k,F,E,L,A,D,S,y,N;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,new Promise((function(e){var t=_.getLineVersion();if(!t||o.compareVersion(t,"9.5.0")<0)e();else if(window._liff&&window._liff.features)e();else{h.logger.debug("cannot find window._liff.features, listen to ready event");var r=function(){h.logger.debug("ready event is fired"),v.removeListener("ready",r),e()};v.addListener("ready",r)}}))];case 1:return e.sent(),W(),[4,V(t.liffId)];case 2:if(c=e.sent(),l=c.access_token,f=c.context_token,w=c.feature_token,b=c.id_token,m=c.client_id,C=c.mst_verifier,T=c.mst_challenge,k=c.msit,f){if("string"!=typeof f)throw o.createLiffError(s.INIT_FAILED,"Cannot get context token, perhaps there is an incorrect parameter in permanent link");i.setContext(O(f))}if(void 0!==(null===(r=i.getContext())||void 0===r?void 0:r.liffId)&&(null===(a=i.getContext())||void 0===a?void 0:a.liffId)!==t.liffId)throw o.createLiffError(s.INIT_FAILED,"Invalid LIFF ID");return!u.isSubWindow()&&w&&(!function(e,t){p.isApiAvailable("multipleLiffTransition")&&q({pathname:"app/".concat(e),query:{feature_token:t}})}(t.liffId,w),M()&&i.setFeatureToken(w)),T&&i.setMSTChallenge(T),C&&i.setMSTVerifier(C),m&&i.setClientId(m),k&&i.setMSIT(k),window.addEventListener("pageshow",K),n.isLoggedIn()?[3,5]:w&&l?[3,5]:M()?(F=o.addParamsToUrl(location.href,{"liff.hback":"2"}),I.login({redirectUri:F}),[4,new Promise((function(){}))]):[3,4];case 3:e.sent(),e.label=4;case 4:throw I.login(),o.createLiffError(s.INIT_FAILED,"Failed to parse feature_token or access_token");case 5:return l&&w?[4,g.verifyAccessToken(l)]:[3,7];case 6:if(E=e.sent(),L=E.client_id,A=E.expires_in,D=o.extractChannelIdFromLiffId(t.liffId),L!==D)throw I.login(),o.createLiffError(s.INIT_FAILED,"Failed to verify access_token");i.setFeatureToken(w),i.setExpireTime(new Date(Date.now()+1e3*A)),i.setAccessToken(l),e.label=7;case 7:return[4,P(k,C)];case 8:return(S=e.sent())?(i.setMST(S),[4,d.getAppData({mst:S})]):[3,10];case 9:(y=e.sent().data)&&i.setAppData(JSON.stringify(y)),e.label=10;case 10:return b&&!i.getIDToken()&&i.setIDToken(b),b&&m&&!i.getDecodedIDToken()?[4,x(b,m)]:[3,12];case 11:(N=e.sent())&&i.setDecodedIDToken(N),e.label=12;case 12:return[2]}}))}))}function j(t){return e.__awaiter(this,void 0,void 0,(function(){var r,n,a,c,l,f,u;return e.__generator(this,(function(e){switch(e.label){case 0:return r=g.getEndPoint("apps"),n="".concat(r,"/").concat(t,"/contextToken"),a=i.getAccessToken(),c={"Content-Type":"application/json",Accept:"application/json"},a&&(c.Authorization="Bearer ".concat(a)),[4,g.fetch(n,{headers:c})];case 1:if(l=e.sent(),!(f=l.contextToken))throw o.createLiffError(s.INIT_FAILED,"Can not get context from server.");if(!(u=O(f)))throw o.createLiffError(s.INIT_FAILED,"Invalid context token.");return[2,u]}}))}))}function J(){return e.__awaiter(this,void 0,void 0,(function(){var t,r;return e.__generator(this,(function(e){switch(e.label){case 0:if(!(t=i.getConfig().liffId))throw o.createLiffError(s.INIT_FAILED,"Invalid LIFF ID.");return[4,j(t)];case 1:return r=e.sent(),i.setContext(r),[2]}}))}))}function G(t){return e.__awaiter(this,void 0,void 0,(function(){var r,n,a,s=this;return e.__generator(this,(function(c){switch(c.label){case 0:r=function(){return e.__awaiter(s,void 0,void 0,(function(){var r,n,a,s,c,l;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,(f=i.getConfig(),u=o.qs.parse(window.location.search),d=i.getLoginTmp(),h={grant_type:"authorization_code",client_id:u.liffClientId,appId:f.liffId,code:u.code,code_verifier:d.codeVerifier,redirect_uri:f.redirectUri||u.liffRedirectUri,id_token_key_type:"JWK"},_=o.qs.stringify(h),g.fetch(g.getEndPoint("token"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:_}))];case 1:return r=e.sent(),n=r.access_token,a=r.id_token,s=r.expires_in,i.setClientId(t),i.setAccessToken(n),i.setExpireTime(new Date(Date.now()+1e3*s)),i.removeLoginTmp(),a?(i.setIDToken(a),[4,x(a,t)]):[3,3];case 2:(c=e.sent())&&i.setDecodedIDToken(c),e.label=3;case 3:return(l=o.qs.parse(location.hash).context_token)?(i.setContext(O(l)),[3,6]):[3,4];case 4:return[4,J()];case 5:e.sent(),e.label=6;case 6:return[2]}var f,u,d,h,_}))}))},c.label=1;case 1:return c.trys.push([1,3,,4]),[4,r()];case 2:return c.sent(),[3,4];case 3:throw n=c.sent(),a=n,i.removeLoginTmp(),a;case 4:return[2]}}))}))}function z(){return e.__awaiter(this,void 0,void 0,(function(){var t,r,a,c,l,f,u=this;return e.__generator(this,(function(g){switch(g.label){case 0:return(r=d.getMessageBus())?[3,2]:[4,d.initMessageBus(m.WINDOW.SUB)];case 1:r=g.sent(),g.label=2;case 2:return(t=r).isReady()?(a=o.randomAlphaNumericString(8),[4,t.getData("appData")]):[3,8];case 3:return c=g.sent(),l=c.eventName,f=c.data,l!==m.EVENT_NAME.NOT_FOUND?[3,6]:[4,t.teardown()];case 4:return g.sent(),[4,z()];case 5:return[2,g.sent()];case 6:f&&i.setAppData(JSON.stringify(f)),g.label=7;case 7:return t.listen((function(r){return e.__awaiter(u,void 0,void 0,(function(){var n,o;return e.__generator(this,(function(e){return n=r.context,o=n.data,n.eventName===s.SUB_WINDOW_STATUS.INIT&&(null==o?void 0:o.subWindowId)!==a&&b.closeWindow(),n.eventName!==s.SUB_WINDOW_STATUS.CANCEL&&n.eventName!==s.SUB_WINDOW_STATUS.SUBMIT||t.teardown(),[2]}))}))})),n.isLoggedIn()&&t.send({eventName:s.SUB_WINDOW_STATUS.INIT,data:{subWindowId:a,hasOpener:!!window.opener}}),[3,10];case 8:return d.getMainWindowOrigin()?[3,10]:[4,new Promise((function(e){window.addEventListener("message",function(e){return function t(r){var n=r.data,o=r.source,a=r.origin;if(n){var c=n.type,l=n.message;c===s.SUB_WINDOW_HEALTH_CHECK_MESSAGE&&(window.removeEventListener("message",t),l&&i.setAppData(l),d.setMainWindowOrigin(a),o&&o.postMessage&&o.postMessage({status:s.SUB_WINDOW_HEALTH_CHECK_MESSAGE},a),e())}}}(e))}))];case 9:return[2,g.sent()];case 10:return[2]}}))}))}var Y=new(function(){function t(){var e=this;this.getAndValidateContext=function(){var e=i.getContext();if(!e)throw o.createLiffError(s.INIT_FAILED,"Could not get Context from server.");if(!e.endpointUrl)throw o.createLiffError(s.INIT_FAILED,"Could not get endpointUrl from server.");if(!e.permanentLinkPattern)throw o.createLiffError(s.INIT_FAILED,"Could not get permanentLinkPattern from server.");return e},this.decodeState=function(t){var r=e.getAndValidateContext();t=t.replace(/\n/g,"%0D%0A");var n=e.hasTrailingSlash(r.endpointUrl)||e.hasTrailingSlash(t),o=new URL(r.endpointUrl),i=o.origin,a=o.pathname,s=o.search,c=new URL("".concat(i).concat(e.attachSlashAtStart(t))),l=c.pathname,f=c.search,u=c.hash,d="".concat(s).concat(s?f.replace(/\?/g,"&"):f),g="".concat(a).concat(e.attachSlashAtStart(l)).replace("//","/");return(g=e.attachSlashAtStart("".concat(g))).endsWith("/")&&!n&&(g=g.substring(0,g.length-1)),"".concat(i).concat(g).concat(d).concat(u).replace(/%0D%0A/g,"\n")}}return t.prototype.attachSlashAtStart=function(e){return"".concat(e&&e.length>0&&!e.startsWith("/")?"/":"").concat(e)},t.prototype.hasTrailingSlash=function(e){var t=e.indexOf("?"),r=e.indexOf("#"),n=-1;return(n=-1===t&&-1===r?e.length:-1===t?r:-1===r?t:Math.min(t,r))>0&&"/"===e[n-1]},t.prototype.invoke=function(){return e.__awaiter(this,void 0,void 0,(function(){var t,r,n,i,a;return e.__generator(this,(function(e){switch(e.label){case 0:if(t=o.qs.parse(window.location.search),"string"!=typeof(r=t["liff.state"]))return[2];e.label=1;case 1:return e.trys.push([1,4,,5]),n=location.href,(i=this.decodeState(r))===n?[3,3]:(t["liff.hback"]?location.replace(o.addParamsToUrl(i,{"liff.hback":t["liff.hback"]})):location.replace(i),[4,new Promise((function(){}))]);case 2:e.sent(),e.label=3;case 3:return[3,5];case 4:if((a=e.sent()).code===s.INIT_FAILED)throw a;return h.logger.debug(a),[3,5];case 5:return[2]}}))}))},t}());function Q(t,r){return e.__awaiter(this,void 0,void 0,(function(){var a;return e.__generator(this,(function(e){switch(e.label){case 0:if(!t.liffId)throw o.createLiffError(s.INVALID_CONFIG,"liffId is necessary for liff.init()");return i.setConfig(t),!l.isInClient()&&n.isLoggedIn()&&(i.getExpireTime()||f.logout()),a=o.qs.parse(window.location.search),!u.isSubWindow()||l.isInClient()?[3,2]:[4,z()];case 1:e.sent(),e.label=2;case 2:if(a.error&&a.liffOAuth2Error)throw g=a.error,h=a.error_description,_=h.replace(/\+/g," "),v="".concat(g,": ").concat(_),o.createLiffError(s.INIT_FAILED,v);return c=a.code,d=i.getLoginTmp(),Boolean(c&&!n.isLoggedIn()&&d&&d.codeVerifier)?[4,G(a.liffClientId)]:[3,4];case 3:e.sent(),e.label=4;case 4:return l.isInClient()?[4,R(t)]:[3,6];case 5:return e.sent(),[3,8];case 6:return n.isLoggedIn()?[3,8]:[4,J()];case 7:e.sent(),e.label=8;case 8:return[4,Y.invoke()];case 9:return e.sent(),[4,r()];case 10:return e.sent(),o.replaceUrlCredentialRemoved(window.location.href),[2]}var c,d,g,h,_,v}))}))}var X=function(e,t){return new Promise((function(r,n){if(e){var i=document.createElement("script");i.type="module",i.onload=function(){r()},i.src=e,document.head.appendChild(i)}else n(o.createLiffError(s.INVALID_CONFIG,t))}))},Z=function(e){var t="https://static.line-scdn.net/lui/edge/versions/1.13.0/lui-alert.js";return t&&e&&(t=t.replace(/\d{1,2}\.\d{1,2}\.\d{1,3}/,e)),X(t,"LUI_ALERT_URL is not defined")},$=function(){return e.__awaiter(void 0,void 0,void 0,(function(){var t;return e.__generator(this,(function(e){switch(e.label){case 0:return t=function(){var e,t=document.querySelector('script[src*="luivendor.js"]');if(t&&(null===(e=t.src.match(/\d{1,2}\.\d{1,2}\.\d{1,3}/g))||void 0===e?void 0:e.length))return t.src.match(/\d{1,2}\.\d{1,2}\.\d{1,3}/g)[0]}(),t?[3,2]:[4,X("https://static.line-scdn.net/lui/edge/versions/1.13.0/luivendor.js","LUI_VENDOR_URL is not defined")];case 1:e.sent(),e.label=2;case 2:return[4,Z(t)];case 3:return e.sent(),[4,(r=o.randomAlphaNumericString(6),new Promise((function(){var e=document.createElement("div");e.innerHTML='<lui-alert id="'.concat("liffAlert","-").concat(r,'" shown title="').concat(T.t("alert.android.extBrowser.autoLoginWorkaround.title"),'" message="').concat(T.t("alert.android.extBrowser.autoLoginWorkaround.desc"),'" button="').concat(T.t("alert.android.extBrowser.autoLoginWorkaround.button.text"),'"></lui-alert>'),document.body.appendChild(e);var t=document.getElementById("".concat("liffAlert","-").concat(r));t&&t.addEventListener("lui-button-click",(function(){var e=window.open(o.addParamsToUrl(window.location.href,{liffIsEscapedFromApp:"true"}),"_blank");e&&(e.location.href=o.addParamsToUrl(window.location.href,{liffIsEscapedFromApp:"true"}),window.close())}))})))];case 4:return e.sent(),[2]}var r}))}))},ee=function(e){try{return new URL(e).searchParams.get("lineAppVersion")}catch(t){return null}};function te(){var t;return e.__awaiter(this,void 0,void 0,(function(){var r,n;return e.__generator(this,(function(e){switch(e.label){case 0:return r=null!==(t=ee(window.location.href))&&void 0!==t?t:ee(window.document.referrer),!!r&&o.compareVersion(r,"13.10.0")>=0?[2]:l.isInClient()||"android"!==w.getOS()||(n=o.qs.parse(window.location.search))[m.IDENTIFIER_KEY]||n.liffIsEscapedFromApp?[2]:n.liffClientId&&document.referrer.includes("access.".concat("line.me"))?(window.location.href=o.addParamsToUrl(window.location.href,{liffIsEscapedFromApp:"true"}),[2]):n.liffClientId&&document.referrer.includes("android-app://")?[4,$()]:[3,2];case 1:e.sent(),e.label=2;case 2:return n.liffClientId&&""===document.referrer&&1===window.history.length?[4,$()]:[3,4];case 3:e.sent(),e.label=4;case 4:return!document.referrer.includes("liffClientId")||document.referrer.includes("liffIsEscapedFromApp")?[3,6]:[4,$()];case 5:e.sent(),e.label=6;case 6:return[2]}}))}))}var re=function(t){function o(){var e=null!==t&&t.apply(this,arguments)||this;return e.hooks={before:new C.AsyncHook,after:new C.AsyncHook},e.internalHooks={beforeFinished:new C.AsyncHook,beforeSuccess:new C.AsyncHook,error:new C.AsyncHook},e}return e.__extends(o,t),Object.defineProperty(o.prototype,"name",{get:function(){return"init"},enumerable:!1,configurable:!0}),o.prototype.install=function(e){var t=e.liff;return this.liffForWindow=t,this.init.bind(this)},o.prototype.init=function(t,o,i){return e.__awaiter(this,void 0,void 0,(function(){var a;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,this.hooks.before.call()];case 1:e.sent(),s=this.liffForWindow,window&&!window.liff&&(window.liff=s),e.label=2;case 2:return e.trys.push([2,9,,11]),[4,Promise.all([y(this.liffForWindow),Q(t,this.internalHooks.beforeFinished.call)])];case 3:return e.sent(),E(),[4,this.internalHooks.beforeSuccess.call()];case 4:return e.sent(),!t.withLoginOnExternalBrowser||n.isLoggedIn()?[3,6]:(I.login(),[4,new Promise((function(){}))]);case 5:e.sent(),e.label=6;case 6:return[4,te()];case 7:return e.sent(),[4,this.hooks.after.call()];case 8:return e.sent(),"function"==typeof o&&o(),r.done(),[3,11];case 9:return a=e.sent(),[4,this.internalHooks.error.call(a)];case 10:throw e.sent(),"function"==typeof i&&i(a),a;case 11:return[2]}var s}))}))},o}(t.LiffModule);exports.InitModule=re;
