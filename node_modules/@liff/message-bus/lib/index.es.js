import{__assign as e,__awaiter as t,__generator as n}from"tslib";import{createLiffError as i,randomAlphaNumericString as s}from"@liff/util";import{SUB_WINDOW_STATUS as r,UNKNOWN as a}from"@liff/consts";var o="liff.subwindow.identifier",c="liff.subwindow.cryptokey",d=e(e({},r),{GET_DATA:"getData",SET_DATA:"setData",NOT_FOUND:"notFound",TEARDOWN:"teardown"}),u={BROADCAST:"broadcast",COMMAND:"command"},f={MAIN:"main",SUB:"sub"},l="__liff_message_bus__",h="bFSQbce18HC7UXe-lS_mgg",v=function(e){return t(void 0,void 0,void 0,(function(){var t;return n(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,window.crypto.subtle.importKey("jwk",{kty:"oct",k:e,alg:"A128GCM",ext:!0},{name:"AES-GCM"},!1,["encrypt","decrypt"])];case 1:return[2,n.sent()];case 2:throw t=n.sent(),i(a,t);case 3:return[2]}}))}))},p=function(e,s,r){return t(void 0,void 0,void 0,(function(){var t,o,c,d;return n(this,(function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),t=(new TextEncoder).encode(e),[4,v(s)];case 1:return o=n.sent(),[4,window.crypto.subtle.encrypt({name:"AES-GCM",iv:t},o,(new TextEncoder).encode(r))];case 2:return c=n.sent(),[2,btoa(new Uint8Array(c).reduce((function(e,t){return e+String.fromCharCode(t)}),""))];case 3:throw d=n.sent(),i(a,d);case 4:return[2]}}))}))},m=function(e,s,r){return t(void 0,void 0,void 0,(function(){var t,o,c,d,u,f,l;return n(this,(function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),t=(new TextEncoder).encode(e),[4,v(s)];case 1:for(o=n.sent(),c=atob(r),d=new Uint8Array(c.length),u=0;u<c.length;u++)d[u]=c.charCodeAt(u);return[4,window.crypto.subtle.decrypt({name:"AES-GCM",iv:t},o,d.buffer)];case 2:return f=n.sent(),[2,(new TextDecoder).decode(new Uint8Array(f))];case 3:throw l=n.sent(),i(a,l);case 4:return[2]}}))}))},w=function(e,t){return y(e)===y(t)},y=function(e){return"".concat(e.identifier,"-").concat(e.action,"-").concat(e.timestamp)},g=function(e){return Object.keys(r).map((function(e){return r[e]})).includes(e)?u.BROADCAST:u.COMMAND};function b(){var e=document.createElement("form");e.method="POST",e.action="$MESSAGE_HANDLER_URL";var t=document.createElement("input");t.type="hidden",t.name="identifier",t.value="$IDENTIFIER",e.appendChild(t),document.body.appendChild(e),e.submit()}var E=function(r){void 0===r&&(r=f.MAIN);var o=this;this.identification={identifier:"",cryptoKey:""},this.messageHandlerInstance=null,this.listeners=new Map,this.sentMessages=[],this.generateIdentification=function(){return t(o,void 0,void 0,(function(){var e,r,o,d,u;return n(this,(function(l){switch(l.label){case 0:return e=new URLSearchParams(window.location.search),r=function(t){var n=e.get("liff.state");return n?new URLSearchParams(n).get(t):null},o=this,u={identifier:this.windowType===f.MAIN?s(12):e.get("liff.subwindow.identifier")||r("liff.subwindow.identifier")||""},this.windowType!==f.MAIN?[3,2]:[4,t(void 0,void 0,void 0,(function(){var e,t,s;return n(this,(function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),[4,window.crypto.subtle.generateKey({name:"AES-GCM",length:128},!0,["encrypt","decrypt"])];case 1:return e=n.sent(),[4,window.crypto.subtle.exportKey("jwk",e)];case 2:if(!(t=n.sent())||!t.k)throw i(a,"failed to generate key");return[2,t.k];case 3:throw s=n.sent(),i(a,s);case 4:return[2]}}))}))];case 1:return d=l.sent(),[3,3];case 2:d=e.get(c)||r(c)||"",l.label=3;case 3:return o.identification=(u.cryptoKey=d,u),[2]}}))}))},this.hasIdentification=function(){var e=o.identification,t=e.identifier,n=e.cryptoKey;return"string"==typeof t&&"string"==typeof n&&t.length>0&&n.length>0},this.isReady=function(){return o.hasIdentification()&&!!o.messageHandlerInstance},this.setup=function(){return t(o,void 0,void 0,(function(){var e,t,s,r,o,c=this;return n(this,(function(n){switch(n.label){case 0:return this.messageHandlerInstance?[2]:[4,this.generateIdentification()];case 1:if(n.sent(),!(e=this.identification.identifier))return[2];if(t=/^[a-zA-Z0-9]+$/gm,!e.match(t))throw i(a,"Invalid identifier");return(s=document.createElement("iframe")).style.display="none",s.src="about:blank",document.body.appendChild(s),null===(o=null==s?void 0:s.contentWindow)||void 0===o||o.window.eval("(".concat(b.toString().replace("$MESSAGE_HANDLER_URL","".concat("https://liff-subwindow.line.me/liff/v2/sub/messageHandler")).replace("$IDENTIFIER",e.split("'")[0]),")()")),r="iframe-".concat(e,"-ready"),[4,new Promise((function(e){var t=function(n){n.data[r]&&(c.messageHandlerInstance=s,window.addEventListener("message",c.proxyToListeners),e(),document.removeEventListener("message",t))};window.addEventListener("message",t)}))];case 2:return[2,n.sent()]}}))}))},this.teardown=function(){return t(o,void 0,void 0,(function(){var e,t;return n(this,(function(n){switch(n.label){case 0:return this.isReady()?[4,this.send({eventName:d.TEARDOWN})]:[3,2];case 1:n.sent(),window.removeEventListener("message",this.proxyToListeners),this.listeners.clear(),null===(t=null===(e=this.messageHandlerInstance)||void 0===e?void 0:e.parentNode)||void 0===t||t.removeChild(this.messageHandlerInstance),this.messageHandlerInstance=null,n.label=2;case 2:return[2]}}))}))},this.listen=function(e){o.listeners.set(e,e)},this.listenRepliedEvent=function(e,t){var n=function(i){i.replyTarget&&w(i.replyTarget,e)&&(t(i),o.listeners.delete(n))};o.listeners.set(n,n)},this.send=function(e){return t(o,void 0,void 0,(function(){var t,s,r,a,o=this;return n(this,(function(n){switch(n.label){case 0:if(!this.isReady())throw i("message bus is not ready to send message");return s={action:g(e.eventName),identifier:this.identification.identifier||"",timestamp:(new Date).getTime()},[4,this.getEncryptedContext(e)];case 1:return s.context=n.sent(),t=s,null===(a=null===(r=this.messageHandlerInstance)||void 0===r?void 0:r.contentWindow)||void 0===a||a.postMessage({messageBusEvent:t},"*"),this.sentMessages.push(y(t)),[4,new Promise((function(e){o.listenRepliedEvent(t,(function(t){e(t.context)}))}))];case 2:return[2,n.sent()]}}))}))},this.reply=function(e,s){return t(o,void 0,void 0,(function(){var t,r,o,c;return n(this,(function(n){switch(n.label){case 0:if(!this.isReady())throw i("message bus is not ready to send message");if(!e.identifier||!e.timestamp)throw i(a,"target message is not valid");return r={action:u.BROADCAST},[4,this.getEncryptedContext(s)];case 1:return r.context=n.sent(),r.identifier=this.identification.identifier||"",r.timestamp=(new Date).getTime(),r.replyTarget={action:e.action,identifier:e.identifier,timestamp:e.timestamp},t=r,null===(c=null===(o=this.messageHandlerInstance)||void 0===o?void 0:o.contentWindow)||void 0===c||c.postMessage({messageBusEvent:t},"*"),this.sentMessages.push(y(t)),[2]}}))}))},this.setData=function(e,t){void 0===e&&(e="appData"),o.send({eventName:d.SET_DATA,key:e,data:t})},this.getData=function(e){return void 0===e&&(e="appData"),t(o,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return[4,this.send({eventName:d.GET_DATA,key:e})];case 1:return[2,t.sent()]}}))}))},this.proxyToListeners=function(i){return t(o,void 0,void 0,(function(){var s,r=this;return n(this,(function(a){return s=i.data.messageBusEvent,"https://liff-subwindow.line.me"!==i.origin?[2]:s?(this.sentMessages.includes(y(s))||s.identifier!==this.identification.identifier||s.action!==u.BROADCAST&&!s.replyTarget||this.listeners.forEach((function(i){return t(r,void 0,void 0,(function(){var t,r,a;return n(this,(function(n){switch(n.label){case 0:return t=i,r=[e({},s)],a={},[4,this.getDecryptedContext(s.context)];case 1:return t.apply(void 0,[e.apply(void 0,r.concat([(a.context=n.sent(),a)]))]),[2]}}))}))})),[2]):[2]}))}))},this.getEncryptedContext=function(e){return t(o,void 0,void 0,(function(){var t,i,s,r,a,o,c;return n(this,(function(n){switch(n.label){case 0:return t=this.identification,i=t.identifier,s=t.cryptoKey,a=(r=JSON).stringify,c={eventName:e.eventName,key:e.key?e.key:void 0},e.data?[4,p(i,s,JSON.stringify(e.data))]:[3,2];case 1:return o=n.sent(),[3,3];case 2:o=void 0,n.label=3;case 3:return[2,a.apply(r,[(c.data=o,c)])]}}))}))},this.getDecryptedContext=function(i){return t(o,void 0,void 0,(function(){var t,s,r,a,o,c,d,u;return n(this,(function(n){switch(n.label){case 0:return t=this.identification,s=t.identifier,r=t.cryptoKey,(a=JSON.parse(i)).data&&"string"==typeof a.data?(u=(d=JSON).parse,[4,m(s,r,a.data)]):[3,2];case 1:return c=u.apply(d,[n.sent()]),[3,3];case 2:c=void 0,n.label=3;case 3:return o=c,[2,e(e({},a),{data:o})]}}))}))},this.windowType=r};export{u as ACTION,c as CRYPTO_KEY,d as EVENT_NAME,l as GLOBAL_MESSAGE_BUS_IDENTIFIER,h as GLOBAL_MESSAGE_BUS_KEY,o as IDENTIFIER_KEY,E as MessageBus,f as WINDOW,g as getEventAction,y as getUniqId,w as isSameEvent,b as loadMessageHandlerPage};
